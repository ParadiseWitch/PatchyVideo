<!-- saved from url=(0056)file:///C:/Users/Administrator/Desktop/Video%20List.html -->
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <link rel="stylesheet" type="text/css" href="{{ url_for('static',filename='css/new/common.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static',filename='css/new/Top-navbar.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static',filename='css/new/videolist.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static',filename='css/new/component.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static',filename='css/new/Playlists.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="{{ url_for('static',filename='js/generic.js') }}"></script>
    <script src="{{ url_for('static',filename='js/playlist.js') }}"></script>

    <style type="text/css">
        .operation {
            display: inline;
        }
    </style>
    <style type="text/css">
        body {
            background:none;
        }
        .fa-close{
        text-decoration: none;
        outline: none;
        background: none;
        border: none;
        color: #265778;
        }
        #addtag{
        vertical-align: bottom;
        }

        #btn input{

        height: 50px;
        background-color: ghostwhite;
        color: #265778;
        outline: none;
        border: 1px solid white;
        font-size: 20px;
        position: absolute;
        left: 40%;
        top: 50%;
        }
        #btn input:hover{
        background-color: ghostwhite;
        }

        #tag{
        width: 1200px;
        height: 923px;
        background:url("/static/img/Patchouli.jpg") no-repeat  ;

        background-size: 1200px 923px;
        box-shadow:  0px 0px 5px crimson;
        /*  padding: 50px;*/
        text-align: center;

        display: none;
        position: absolute;
        top: -90px;
        left: 13%;
        z-index: 100;


        }
        .minibox{

        /*             background-color: rgba(255,255,255,0.5);*/
        display: none;
        height: 100%;
        position: relative;
        z-index: 0;
        top:-30px;
        }


        .Taglist{
        padding-top: 2px;
        /*        margin-bottom: 20px;*/
        /*  height: 400px;*/
        overflow:auto;
        position: relative;
        }
        .Taglist li{
        background-color: rgba(255,255,255,0.5);
        display: inline-block;
        zoom: 1;
        padding: 12px;
        margin-left: 10px;
        text-align: center;
        vertical-align: middle;  cursor: pointer;
        list-style: none;
        border-radius: 50px;

        }
        .Taglist p, p> input{
        display: inline-block;
        font-size:18px;
        line-height: 20px;
        margin: 0px 0px 0px 0px!important;
        }.Taglist i{
        display: inline-block;
        }
        .m_a{
        color: rgba(255, 255, 255, 0.8);
        }
        .m_b{
        color: rgba(255, 255, 255, 0.8);
        position: absolute;
        bottom: 18%;
        left: 38%;
        }
        .m_a div{
        margin-bottom: 10px;
        }
        .item input{
            text-decoration: none;
            outline: none;
            background: none;
            border: none;
        }
        .tag_title{
        position: absolute;
        bottom: 44%;
        color: white;
        left: 42%;
        font-size: 25px;
        z-index:-1;
        }
        /*      .tag_title:nth-child(4){
        opacity: 0;
        }*/
        #save{
        position: relative;
        left: 0px;
        bottom: -800px;
        color: white;
        z-index: 999;
        }
        #close{

        position: relative;
        /*     right: -50px;
        bottom: 40px;*/
        right: -570px;
        top: 20px;
        color: white;
        z-index: 999;
        }

        #close:hover,#save:hover{

        color: cornflowerblue;
        }

        #ipt{
        height: 250px;
        width: 300px;
        font-size: 22px;
        padding-top: 10px;
        padding-left: 10px;
        font-weight: bolder;
        text-rendering: auto;
        outline: none;
        border: none;
        color:  #265778;
        letter-spacing: normal;
        word-spacing: normal;
        text-transform: none;
        text-indent: 0px;
        text-shadow: none;
        display: inline-block;
        text-align: start;

        background-color: rgba(255, 255, 255, 0.3);
        }

        .minibox:before{
        content: "";
        position: absolute;
        width: 100%;
        height: 41%;
        top: 57%;
        left: 0%;
        background: url("/static/img/Patchouli.jpg") no-repeat;
        background-size: 1200px 923px;
        filter: blur(98px);
        z-index: -2;
        }
        .m_bg:before{
        content: "";
        position: absolute;
        width: 100%;
        height: 40%;
        top: 0%;
        left: 0%;
        background: url("/static/img/Patchouli.jpg") no-repeat;
        background-size: 1200px 923px;
        filter: blur(100px);
        z-index: -2;
        }
        .Copyright > li > p {
            color: #A0A;
        }
        .Language > li > p {
            color: #585455;
        }
        .Character > li > p {
            color: #0A0;
        }
        .Author > li > p {
            color: #A00;
        }
        .General > li > p {
            color: #0073ff;
        }
        .Meta > li > p {
            color: #F80;
        }

    </style>
    <title>{{playlist_title}} - PatchyVideo</title>
</head>

<body>
    <meta id="page" content="{{page}}">
    </meta>
    <meta id="query" content="{{query}}">
    </meta>
    <meta id="page-size" content="{{page_size}}">
    </meta>
    <meta id="page-count" content="{{page_count}}">
    </meta>
    <meta id="order" content="{{order}}">
    </meta>
    <meta id="playlist-id" content="{{playlist_id}}">
    </meta>
    <div class="top-navbar w " id="top-navbar">
        <div class="nav_left">
            <ul>
                <li><a href="/">Home</a></li>
                <li><a href="/lists">Playlists</a></li>
                <li><a href="/postvideo">Post Video</a></li>
                <li><a href="/edittag">Tags</a></li>
            </ul>
        </div>
        <div class="nav_right">
            <ul>
                {% include "searchbar_new.html" %}
                {% if _user is none %}
                <li><a href="/login">Login</a></li>
                <li><a href="/signup">Sign up</a></li>
                {% else %}
                <li><a href="/users/{{_user['_id']}}">{{_user['profile']['username']}}</a></li>
                <li><a href="/logout">Log out</a></li>
                {% endif %}
            </ul>
        </div>
    </div>
    <div class="w">
        <div class="content">
            <div class="deemo shadow">
                <div class="d_t">
                    <h2>{{playlist_title}}</h2>
                    {% if playlist_editable %}
                    <div style="text-align: center">
                        <span><a class="operation" href="/list/{{playlist_id}}/add">[Add video]</a></span>
                        <span><a class="operation" href="/list/{{playlist_id}}/edit">[Edit]</a></span>
                        <span><a id="edit_tags" class="operation" href="#">[Edit Common Tags]</a></span>
                        <span><a class="operation" href="/list/{{playlist_id}}/del">[Delete]</a></span>
                    </div>
                    {% endif %}
                    <a href=""><img src="/images/covers/{{playlist_cover_image}}" width="320px" height="200px" alt="" title=""></a>
                    <p style="white-space: pre-wrap;">{{playlist_desc}}</p>
                </div>
            </div>
            <ul>
                {% for vid in videos %}
                <li class="list-item">
                    <div>
                        <span>
                            <h3 style="display: inline">{{vid.rank + 1}}</h3>
                        </span>
                        {% if playlist_editable %}
                        <span><a class="operation" href="javascript:moveUp('{{vid._id}}');">[Move Up]</a></span>
                        <span><a class="operation" href="javascript:moveDown('{{vid._id}}');">[Move Down]</a></span>
                        <span><a class="operation" href="/list/{{playlist_id}}/insert?rank={{vid.rank}}">[Insert Video here]</a></span>
                        <span><a class="operation" href="javascript:deleteVideo('{{vid._id}}');">[Delete]</a></span>
                        <span><a class="operation" href="javascript:setCover('{{vid._id}}');">[Set Video Cover as Playlist Cover]</a></span>
                        {% endif %}
                    </div>
                    <div class="video-thumbnail">
                        {% if vid.item.cover_image|length == 0 %}
                        <img src="/proxy?url={{vid.item.thumbnail_url}}&amp;header=%7B%22User-Agent%22:%22Mozilla/5.0%20(X11;%20Ubuntu;%20Linu%E2%80%A6)%20Gecko/20100101%20Firefox/65.0%22%7D"
                            width="160px" height="100px">
                        {% else %}
                        <img src="/images/covers/{{vid.item.cover_image}}" width="160px" height="100px">
                        {% endif %}
                    </div>
                    <div class="video-detail">
                        <h4>{{vid.item.title}} <a href="/video?id={{vid._id}}">[Detail]</a>
                        </h4>
                        <p>{{vid.item.desc}}</p>
                        <div>
                            <img src="{{ url_for('static',filename='img/' + vid.item.site + '.ico') }}" width="16px"></img>
                            <a href="{{vid.item.url}}" id="link_{{vid._id}}">{{vid.item.url}}</a>
                            <i onclick="javascript:copyToClipboard($('#link_{{vid._id}}'));" class="fa fa-copy fa-lg"></i>
                        </div>
                        <style>
                            .fa-copy:hover {
                                color:olive;
                            }
                        </style>
                    </div>
                </li>
                {% endfor %}
            </ul>
            <p class="page-selector">{{page_selector_text|safe}}</p>
            <div id="tag">
                <i class="fa fa-close fa-2x" id="close"></i>
                <i class="fa fa-circle-o fa-3x" id="save"></i>
                <div class="minibox">



                    <div class="m_bg">

                    </div>
                    <div class="m_a">
                        <ul class="Taglist Copyright">

                        </ul>
                        <ul class="Taglist Language">

                        </ul>
                        <ul class="Taglist Character">

                        </ul>
                        <ul class="Taglist Author">

                        </ul>
                        <ul class="Taglist General">

                        </ul>
                        <ul class="Taglist Meta">

                        </ul>


                    </div>

                    <div class="m_b">

                        <div>

                            <textarea id="ipt"></textarea>
                            <!--<input class="fa fa-plus-square" type="button"value="add">-->
                            <span id="addtag"> <i class="fa fa-plus-square fa-2x"></i></span>

                        </div>


                    </div>
                </div>
                <span class="tag_title">Edit Common Tags</span>
                <span class="tag_title">Tag already exist</span>
                <span class="tag_title">Tag not exist</span>

            </div>
        </div>
    </div>
    <div class="footer w">
        <p> © 2019 www.patchyvideo.com Touhou Project </p>
    </div>


    </div>
    <script>

        $(function () {
            var input = $("<input>");
            $('.tag_title:last').stop().animate({ opacity: 0 });
            $('.tag_title:eq(1)').stop().animate({ opacity: 0 });

            function getAjaxValue(tagsSet) {
                var s = 0;
                $.ajax({
                    type: "POST",
                    url: "/tags/query_tag_categories.do",
                    async: false,
                    contentType: 'application/json',
                    data: JSON.stringify({ "tags": Array.from(tagsSet) }),
                    success: function (result) {
                        s = result.data.categorie_map;
                    },

                });
                return s;
            };

            function getCommonTags() {
                var s = 0;
                $.ajax({
                    type: "POST",
                    url: "/list/getcommontags.do",
                    async: false,
                    contentType: 'application/json',
                    data: JSON.stringify({ "pid": $("#playlist-id").attr("content") }),
                    success: function (result) {
                        s = result.data;
                    },
                });
                return s;
            }


            function addCommonTags(tags) {
                let v = getAjaxValue(tags);
                for (var i in v) {
                    if ($(`.${v[i]}`).children('div').length == 0) {
                        $(`.${v[i]}`).append(`<div>${v[i]}：</div><li class="item"><p class="val_${i}">${i}</p><i class="fa fa-close"></i></li>`);
                    }
                    else if ($(`.${v[i]}`).find(`.val_${i}`).length == 0 && $(`.${v[i]}`).length != 0) {
                        $(`.${v[i]}`).append(`<li class="item"><p class="val_${i}">${i}</p><i class="fa fa-close"></i></li>`);
                    }
                    else {
                    }

                }
            }
            
            function clearTags() {
                let uls = $('.Taglist');
                for (var i = 0; i != uls.length; ++i) {
                    while (uls[i].hasChildNodes()) {
                        uls[i].removeChild(uls[i].lastChild);
                    }
                }
            }

            function ifval() {
                let inputSet = new Set(input.val().split(/[\s,]/));
                let v = getAjaxValue(inputSet);
                if (JSON.stringify(v) != '{}') {
                    input.parent().html(input.val());
                }

                if (input.val() == '') {
                    if ($("input").parents('.item').siblings('.item').length == 0) {
                        input.parent().parent().parent().children().remove();
                    }
                    else {
                        input.parent().parent().remove();
                    }
                }
            }
            /*$('html').on('dblclick', function () {

                ifval();
            })*/
            $('#edit_tags').on('click', function () {
                clearTags();
                let tags = getCommonTags();
                addCommonTags(tags);
                $('#tag').stop().fadeIn('slow').animate({
                }, function () {
                    $('.minibox').fadeIn('slow');

                });

            });
            $('#ipt').mouseenter(function () {
                $('.tag_title').stop().animate({ opacity: 0 });
            })
            $('.m_b').on('click', '#addtag', function (event) {
                let tagsSet = new Set($('#ipt').val().split(/[\s,]/));
                let v = getAjaxValue(tagsSet);
                let validTags = new Set(Object.keys(v));
                let invalidTags = new Set([...tagsSet].filter(x => !validTags.has(x)));

                for (var i in v) {
                    if ($(`.${v[i]}`).children('div').length == 0) { //当第一次创建分类区域，
                        /*
                                        $('.m_a').append($('<ul class="Taglist">').addClass(`${v[i]}`).append(`<div>${v[i]}：</div><li class="item"><p class="val_${i}">${i}</p><i class="fa fa-close"></i></li>`));
                        */
                        $(`.${v[i]}`).append(`<div>${v[i]}：</div><li class="item"><p class="val_${i}">${i}</p><i class="fa fa-close"></i></li>`);
                    }

                    else if ($(`.${v[i]}`).find(`.val_${i}`).length == 0 && $(`.${v[i]}`).length != 0) { //当分类区域已创建，tag不存在时
                        $(`.${v[i]}`).append(`<li class="item"><p class="val_${i}">${i}</p><i class="fa fa-close"></i></li>`);
                    }
                    else {
                        $('.tag_title:eq(1)').stop().animate({ opacity: 1 }, 1000, function () {
                            $(this).animate({ opacity: 0 }, 3000)
                        });
                        invalidTags.delete(i);
                    }

                }

                $("#ipt").val(Array.from(invalidTags).join('\n'));

                if (Array.from(invalidTags).length != 0) {

                    $('.tag_title:last').stop().animate({ opacity: 1 }, 1000, function () {
                        $(this).animate({ opacity: 0 }, 3000)
                    });
                }
                $('.tag_title:first').fadeOut(1000);

                event.stopPropagation();
            });

            $('.minibox').on('click', '.fa', function () {
                let ulobj = $(this).parents('ul');
                let itemlength = $(this).parents('.item').siblings('.item').length;


                if (itemlength == 0) {
                    ulobj.children().remove();
                } else {
                    $($(this)[0].parentNode).remove();
                }

            })
            /*$('.fa').on('click',function () {
    
            });*/

            $('.m_a').on('click ', 'p', function () {
                var li = $(this);
                var text = $(this).text();
                li.html("");
                input.attr("value", text);
                input.keyup(function (event) {
                    var myEvent = event || window.event;
                    var kcode = myEvent.keyCode;
                    if (kcode == 13) {
                        ifval();
                    }
                });
                li.append(input);
                //让文本框里边的文章被高亮选中将jquery的对象转换成dom对象
                var inpuliom = input.get(0);
                inpuliom.select();
            });

            $('#tag').on('click', '#close', function () {
                $('.minibox').hide();
                $('#tag').animate({

                }, function () {
                    $(this).fadeOut('linear')
                });
            });

            $('#save').click(function () {
                var tags = [];
                for(let i = 0; i != $('.m_a ul').length; ++i){
                    let key = $($('.m_a ul')[i]).children('div').text();
                    let items = $($('.m_a ul')[i]).children('li.item');
                    for (let j = 0; j != items.length; ++j) {
                        let value = items[j].innerText;
                        if (key != ''){
                            tags.push(value);
                        }
                    }
                }
                postJSON("/list/setcommontags.do",{
                    "pid": $("#playlist-id").attr("content"),
                    "tags": tags
                }, function(result){
                    ;
                });
                $('.minibox').hide();
                $('#tag').animate({}, function () {
                    $(this).fadeOut('linear')
                });
            })


        })
    </script>

</body>

</html>